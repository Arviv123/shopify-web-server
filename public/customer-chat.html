<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×¦'××˜ ×§× ×™×™×” ×—×›× - ×—×¤×© ×•×”×–××Ÿ ××•×¦×¨×™×</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: SÃ¶hne, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, Cantarell, "Noto Sans", sans-serif;
            background: #ffffff;
            direction: rtl;
            height: 100vh;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 100%;
            margin: 0 auto;
            background: #ffffff;
        }

        .chat-header {
            background: #ffffff;
            color: #374151;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid #d1d5db;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-icon {
            width: 20px;
            height: 20px;
            font-size: 20px;
        }

        .header-title {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            display: flex;
            flex-direction: column;
            background: #ffffff;
        }

        .message {
            width: 100%;
            padding: 24px 0;
            animation: messageSlideIn 0.3s ease-out;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            background: #f7f7f8;
        }

        .message.assistant {
            background: #ffffff;
        }

        .message-wrapper {
            max-width: 768px;
            margin: 0 auto;
            padding: 0 16px;
            display: flex;
            gap: 16px;
        }

        .avatar {
            width: 30px;
            height: 30px;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .avatar.user {
            background: #19c37d;
            color: white;
        }

        .avatar.assistant {
            background: #ab68ff;
            color: white;
        }

        .message-content {
            flex: 1;
            font-size: 16px;
            line-height: 1.75;
            color: #374151;
            word-wrap: break-word;
        }

        .typing-indicator {
            display: none;
            font-style: italic;
            color: #666;
        }

        .typing-dots {
            display: inline-flex;
            gap: 3px;
            margin-left: 8px;
        }

        .typing-dots span {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #666;
            animation: typingAnimation 1.4s infinite ease-in-out both;
        }

        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingAnimation {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .chat-input-container {
            padding: 16px;
            background: #ffffff;
            border-top: 1px solid #d1d5db;
        }

        .input-wrapper {
            position: relative;
            max-width: 768px;
            margin: 0 auto;
        }

        .chat-input {
            width: 100%;
            min-height: 24px;
            max-height: 120px;
            padding: 12px 48px 12px 16px;
            border: 1.5px solid #d1d5db;
            border-radius: 12px;
            font-size: 16px;
            font-family: inherit;
            resize: none;
            outline: none;
            transition: all 0.2s ease;
            background: #ffffff;
            direction: rtl;
        }

        .chat-input:focus {
            border-color: #10a37f;
            box-shadow: 0 0 0 2px rgba(16, 163, 127, 0.2);
        }

        .chat-input::placeholder {
            color: #9ca3af;
        }

        .send-button {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 32px;
            height: 32px;
            border: none;
            background: #000000;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            opacity: 0.4;
        }

        .send-button:hover:not(:disabled) {
            opacity: 1;
            background: #000000;
        }

        .send-button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .product-card {
            background: #ffffff;
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            padding: 16px;
            margin: 8px 0;
            transition: all 0.2s ease;
        }

        .product-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: #10a37f;
        }

        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .product-title {
            font-weight: 600;
            color: #111827;
            font-size: 16px;
            line-height: 1.4;
        }

        .product-price {
            font-size: 20px;
            font-weight: 700;
            color: #10a37f;
            margin-right: 16px;
        }

        .product-details {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 16px;
        }

        .product-vendor {
            display: inline-block;
            background: #f3f4f6;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            margin-left: 8px;
        }

        .order-button {
            width: 100%;
            background: linear-gradient(135deg, #10a37f, #0d8f69);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .order-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 163, 127, 0.3);
        }

        .welcome-message {
            max-width: 768px;
            margin: 0 auto;
            padding: 40px 20px;
            color: #6b7280;
            text-align: center;
        }

        .welcome-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .welcome-title {
            font-size: 24px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 8px;
        }

        .welcome-subtitle {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 24px;
        }

        .quick-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .quick-action {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            color: #374151;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quick-action:hover {
            background: #10a37f;
            color: white;
            border-color: #10a37f;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .chat-container {
                height: 100vh;
                max-width: 100%;
            }
            
            .message-wrapper {
                padding: 0 16px;
            }
            
            .chat-input-container {
                padding: 12px 16px;
            }

            .product-card {
                padding: 12px;
            }

            .product-header {
                flex-direction: column;
                gap: 8px;
            }

            .product-price {
                margin-right: 0;
                align-self: flex-start;
            }
        }

        /* Scrollbar Styling */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: #f7f7f8;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Header -->
        <div class="chat-header">
            <div class="header-content">
                <div class="chat-icon">ğŸ›’</div>
                <div class="header-title">×¦'××˜ ×§× ×™×™×” ×—×›× - ×—×¤×© ×•×”×–××Ÿ ××•×¦×¨×™×</div>
            </div>
        </div>

        <!-- Messages -->
        <div class="chat-messages" id="messagesContainer">
            <div class="welcome-message">
                <div class="welcome-icon">ğŸ¤–</div>
                <div class="welcome-title">×©×œ×•×! ××™×š ××•×›×œ ×œ×¢×–×•×¨ ×œ×š ×”×™×•×?</div>
                <div class="welcome-subtitle">×× ×™ ×›××Ÿ ×œ×¢×–×•×¨ ×œ×š ×œ××¦×•× ×•×œ×”×–××™×Ÿ ××•×¦×¨×™× ××”×—× ×•×™×•×ª ×©×œ× ×•.<br>×¤×©×•×˜ ×ª×’×™×“ ×œ×™ ××” ××ª×” ××—×¤×© ×•×× ×™ ×××¦× ×¢×‘×•×¨×š ××ª ×”××•×¦×¨×™× ×”×˜×•×‘×™× ×‘×™×•×ª×¨!</div>
                
                <div class="quick-actions">
                    <button class="quick-action" onclick="sendQuickMessage('×—×¤×© ×œ×™ ××›× ×¡')">××›× ×¡×™×™×</button>
                    <button class="quick-action" onclick="sendQuickMessage('×—×¤×© ×œ×™ ×—×•×œ×¦×”')">×—×•×œ×¦×•×ª</button>
                    <button class="quick-action" onclick="sendQuickMessage('××•×¦×¨×™ ×™×œ×“×™×')">××•×¦×¨×™ ×™×œ×“×™×</button>
                    <button class="quick-action" onclick="sendQuickMessage('×¦×¢×¦×•×¢×™×')">×¦×¢×¦×•×¢×™×</button>
                    <button class="quick-action" onclick="sendQuickMessage('×˜×›× ×•×œ×•×’×™×”')">×˜×›× ×•×œ×•×’×™×”</button>
                </div>
            </div>

            <!-- Typing Indicator -->
            <div class="message assistant" id="typingIndicator" style="display: none;">
                <div class="message-wrapper">
                    <div class="avatar assistant">AI</div>
                    <div class="typing-indicator">
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        ××—×¤×© ××•×¦×¨×™×...
                    </div>
                </div>
            </div>
        </div>

        <!-- Input -->
        <div class="chat-input-container">
            <div class="input-wrapper">
                <textarea 
                    id="messageInput" 
                    class="chat-input" 
                    placeholder="×”×§×œ×“ ×›××Ÿ ××” ××ª×” ××—×¤×©..."
                    rows="1"
                    onkeydown="handleKeyDown(event)"
                    oninput="adjustTextareaHeight(this)"
                ></textarea>
                <button 
                    id="sendButton" 
                    class="send-button" 
                    onclick="sendMessage()"
                    disabled
                >
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22,2 15,22 11,13 2,9 22,2"></polygon>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Version check for debugging
        console.log('Customer Chat Version: 1.2.3 - Updated functions included');
        
        // Global error handler
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error, e.message, e.filename, e.lineno);
        });

        let conversationHistory = [];
        let currentOrder = null;
        let stores = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, initializing...');
            
            // Check if elements exist
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            console.log('Message input found:', !!messageInput);
            console.log('Send button found:', !!sendButton);
            
            loadStores();
            
            // Test - add a test message to verify UI is working
            setTimeout(() => {
                console.log('Adding test message');
                addMessage('××¢×¨×›×ª × ×˜×¢× ×” ×‘×”×¦×œ×—×”! × ×™×ª×Ÿ ×œ×©×œ×•×— ×”×•×“×¢×•×ª.', 'assistant');
            }, 1000);
            
            // Enable send button when input has text - with better handling
            if (messageInput) {
                messageInput.addEventListener('input', function() {
                    console.log('Input changed:', this.value);
                    const sendButton = document.getElementById('sendButton');
                    if (sendButton) {
                        const hasText = this.value.trim().length > 0;
                        console.log('Has text:', hasText, 'Button disabled before:', sendButton.disabled);
                        sendButton.disabled = !hasText;
                        sendButton.style.opacity = hasText ? '1' : '0.4';
                        sendButton.style.cursor = hasText ? 'pointer' : 'not-allowed';
                        console.log('Button disabled after:', sendButton.disabled);
                    }
                });
                
                // Also check initial state
                const initialText = messageInput.value.trim();
                if (sendButton) {
                    sendButton.disabled = initialText.length === 0;
                    sendButton.style.opacity = initialText.length > 0 ? '1' : '0.4';
                }
            }
        });

        // Load stores
        async function loadStores() {
            try {
                const response = await fetch('/api/stores');
                const data = await response.json();
                stores = data.stores || [];
                console.log('Loaded stores:', stores.length);
            } catch (error) {
                console.error('Error loading stores:', error);
            }
        }

        // Handle keyboard input
        function handleKeyDown(event) {
            console.log('Key pressed:', event.key);
            if (event.key === 'Enter' && !event.shiftKey) {
                console.log('Enter pressed, calling sendMessage');
                event.preventDefault();
                sendMessage();
            }
        }

        // Auto-resize textarea
        function adjustTextareaHeight(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        // Send quick message
        function sendQuickMessage(message) {
            console.log('sendQuickMessage called with:', message);
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            
            if (messageInput && sendButton) {
                messageInput.value = message;
                sendButton.disabled = false;
                sendButton.style.opacity = '1';
                sendButton.style.cursor = 'pointer';
                console.log('Quick message set, button enabled');
                sendMessage();
            }
        }

        // Send message
        async function sendMessage() {
            console.log('sendMessage called');
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            console.log('Message:', message);
            
            if (!message) {
                console.log('No message, returning');
                return;
            }

            // Clear input
            input.value = '';
            input.style.height = 'auto';
            document.getElementById('sendButton').disabled = true;

            // Hide welcome message
            const welcomeMessage = document.querySelector('.welcome-message');
            if (welcomeMessage) {
                welcomeMessage.style.display = 'none';
            }

            // Add user message
            console.log('Adding user message');
            addMessage(message, 'user');

            // Show typing indicator
            console.log('Showing typing indicator');
            showTypingIndicator();

            try {
                console.log('Starting API call');
                // Search for products
                const response = await fetch('/api/chat/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: message, storeId: '' })
                });

                const result = await response.json();

                // Hide typing indicator
                hideTypingIndicator();

                if (result.success) {
                    // Add AI response
                    if (result.aiResponse) {
                        addMessage(result.aiResponse, 'assistant');
                    }

                    // Add products if found
                    if (result.products && result.products.length > 0) {
                        addProductResults(result.products);
                    } else if (!result.aiResponse) {
                        addMessage('×œ× × ××¦××• ××•×¦×¨×™× ×¢×‘×•×¨ ×”×—×™×¤×•×© ×©×œ×š ğŸ˜•<br>× ×¡×” ×—×™×¤×•×© ××—×¨ ××• ×‘×“×•×§ ×©×”×—× ×•×™×•×ª ××—×•×‘×¨×•×ª.', 'assistant');
                    }
                } else {
                    addMessage('âŒ ×©×’×™××”: ' + result.error, 'assistant');
                }

            } catch (error) {
                console.error('Error in sendMessage:', error);
                hideTypingIndicator();
                addMessage('âŒ ×©×’×™××” ×‘×—×™×¤×•×©: ' + error.message, 'assistant');
            }
        }

        // Add message to chat
        function addMessage(content, sender) {
            console.log('addMessage called:', content, sender);
            const messagesContainer = document.getElementById('messagesContainer');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'message-wrapper';
            
            const avatar = document.createElement('div');
            avatar.className = `avatar ${sender}`;
            avatar.textContent = sender === 'user' ? '×× ×™' : 'AI';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.innerHTML = content;
            
            messageWrapper.appendChild(avatar);
            messageWrapper.appendChild(messageContent);
            messageDiv.appendChild(messageWrapper);
            messagesContainer.appendChild(messageDiv);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Add to conversation history
            conversationHistory.push({
                content,
                sender,
                timestamp: new Date()
            });
        }

        // Show typing indicator
        function showTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'block';
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Hide typing indicator
        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        // Add product results
        function addProductResults(products) {
            const messagesContainer = document.getElementById('messagesContainer');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            
            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'message-wrapper';
            
            const avatar = document.createElement('div');
            avatar.className = 'avatar assistant';
            avatar.textContent = 'AI';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            let productsHtml = `<strong>× ××¦××• ${products.length} ××•×¦×¨×™×:</strong><br><br>`;
            
            products.forEach(product => {
                productsHtml += `
                    <div class="product-card">
                        <div class="product-header">
                            <div class="product-title">${escapeHtml(product.title)}</div>
                            <div class="product-price">â‚ª${product.price}</div>
                        </div>
                        <div class="product-details">
                            <span class="product-vendor">${escapeHtml(product.vendor)}</span>
                            ${escapeHtml(product.storeName)}
                        </div>
                        <button onclick="orderProduct('${product.id}', '${product.storeId}', '${escapeHtml(product.title)}', '${product.price}')" class="order-button">
                            ğŸ›’ ×”×–××Ÿ ×¢×›×©×™×•
                        </button>
                    </div>
                `;
            });
            
            messageContent.innerHTML = productsHtml;
            messageWrapper.appendChild(avatar);
            messageWrapper.appendChild(messageContent);
            messageDiv.appendChild(messageWrapper);
            messagesContainer.appendChild(messageDiv);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Order product
        async function orderProduct(productId, storeId, title, price) {
            showCustomerDetailsPopup(productId, storeId, title, price);
        }

        // Show customer details popup
        function showCustomerDetailsPopup(productId, storeId, title, price) {
            const popupContent = `<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×¤×¨×˜×™ ×”×–×× ×” - ${title}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px; 
            direction: rtl; 
            min-height: 100vh;
        }
        .container { 
            max-width: 500px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 20px; 
            padding: 40px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.2); 
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .product-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
        }
        .product-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        .product-price {
            font-size: 28px;
            font-weight: bold;
            color: #10a37f;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #10a37f;
        }
        .required {
            color: #dc2626;
        }
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 0;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #10a37f 0%, #0d8f69 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(16, 163, 127, 0.3);
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .checkbox-group {
            display: flex;
            align-items: flex-start;
            margin: 20px 0;
        }
        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-left: 10px;
            margin-top: 3px;
        }
        .checkbox-group label {
            margin: 0;
            font-size: 14px;
            line-height: 1.5;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>ğŸ›’ ×”×©×œ××ª ×¤×¨×˜×™ ×”×–×× ×”</h2>
            <p>×× × ××œ× ××ª ×”×¤×¨×˜×™× ×”×‘××™× ×œ×‘×™×¦×•×¢ ×”×”×–×× ×”</p>
        </div>
        
        <div class="product-info">
            <div class="product-title">${title}</div>
            <div class="product-price">â‚ª${price}</div>
        </div>
        
        <form id="orderForm" onsubmit="submitOrder(event)">
            <div class="form-group">
                <label for="fullName">×©× ××œ× <span class="required">*</span></label>
                <input type="text" id="fullName" name="fullName" required>
            </div>
            
            <div class="form-group">
                <label for="email">×›×ª×•×‘×ª ××™×™×œ <span class="required">*</span></label>
                <input type="email" id="email" name="email" required>
            </div>
            
            <div class="form-group">
                <label for="phone">××¡×¤×¨ ×˜×œ×¤×•×Ÿ <span class="required">*</span></label>
                <input type="tel" id="phone" name="phone" required placeholder="050-1234567">
            </div>
            
            <div class="form-group">
                <label for="address">×›×ª×•×‘×ª ×œ××©×œ×•×— <span class="required">*</span></label>
                <textarea id="address" name="address" rows="3" required placeholder="×¨×—×•×‘, ××¡×¤×¨ ×‘×™×ª, ×¢×™×¨, ××™×§×•×“"></textarea>
            </div>
            
            <div class="form-group">
                <label for="quantity">×›××•×ª</label>
                <input type="number" id="quantity" name="quantity" value="1" min="1" max="10">
            </div>
            
            <div class="form-group">
                <label for="notes">×”×¢×¨×•×ª (××•×¤×¦×™×•× ×œ×™)</label>
                <textarea id="notes" name="notes" rows="2" placeholder="×”×¢×¨×•×ª ××™×•×—×“×•×ª ×œ×”×–×× ×”"></textarea>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="terms" name="terms" required>
                <label for="terms">×× ×™ ××¡×›×™×/×” ×œ×ª× ××™ ×”×©×™××•×© ×•××“×™× ×•×ª ×”×¤×¨×˜×™×•×ª <span class="required">*</span></label>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="marketing" name="marketing">
                <label for="marketing">×× ×™ ××¡×›×™×/×” ×œ×§×‘×œ ×¢×“×›×•× ×™× ×©×™×•×•×§×™×™× ×‘××™×™×œ (××•×¤×¦×™×•× ×œ×™)</label>
            </div>
            
            <button type="submit" class="btn btn-primary">
                ğŸš€ ×‘×¦×¢ ×”×–×× ×” ×•×¢×‘×•×¨ ×œ×ª×©×œ×•×
            </button>
            
            <button type="button" class="btn btn-secondary" onclick="window.close()">
                âŒ ×‘×™×˜×•×œ
            </button>
        </form>
        
        <div id="loading" class="loading">
            <h3>ğŸ”„ ×™×•×¦×¨ ×”×–×× ×”...</h3>
            <p>×× × ×”××ª×Ÿ, ×™×•×¦×¨ ×”×–×× ×” ×‘-Shopify...</p>
        </div>
    </div>

    <script>
        async function submitOrder(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const customerData = {
                fullName: formData.get('fullName'),
                email: formData.get('email'),
                phone: formData.get('phone'),
                address: formData.get('address'),
                quantity: parseInt(formData.get('quantity')),
                notes: formData.get('notes'),
                marketing: formData.get('marketing') === 'on'
            };
            
            // Show loading
            document.getElementById('orderForm').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            
            try {
                // Send order to parent window
                window.opener.postMessage({
                    type: 'create_order',
                    productId: '${productId}',
                    storeId: '${storeId}',
                    title: '${title}',
                    price: '${price}',
                    customerData: customerData
                }, '*');
                
                // Close popup
                window.close();
                
            } catch (error) {
                alert('×©×’×™××” ×‘×™×¦×™×¨×ª ×”×”×–×× ×”: ' + error.message);
                document.getElementById('orderForm').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
            }
        }
    </script>
</body>
</html>`;
            
            // Open popup window with the HTML content
            const popup = window.open('', 'customer_details', 'width=600,height=800,scrollbars=yes,resizable=no');
            popup.document.open();
            popup.document.write(popupContent);
            popup.document.close();
        }

        // Listen for order creation messages from popup
        window.addEventListener('message', async function(event) {
            if (event.data.type === 'create_order') {
                await processOrderWithCustomerData(event.data);
            } else if (event.data.type === 'payment_completed') {
                handlePaymentComplete(event.data.order);
            }
        });

        // Process order with customer data
        async function processOrderWithCustomerData(orderData) {
            addMessage(`ğŸ”„ ×™×•×¦×¨ ×”×–×× ×” ×××™×ª×™×ª ×‘-Shopify ×¢×‘×•×¨ ${orderData.title}...`, 'assistant');
            
            try {
                const response = await fetch('/api/orders/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        productId: orderData.productId,
                        storeId: orderData.storeId,
                        productTitle: orderData.title,
                        productPrice: orderData.price,
                        quantity: orderData.customerData.quantity || 1,
                        customerInfo: {
                            email: orderData.customerData.email,
                            firstName: orderData.customerData.fullName.split(' ')[0] || '×œ×§×•×—',
                            lastName: orderData.customerData.fullName.split(' ').slice(1).join(' ') || '×—×“×©',
                            phone: orderData.customerData.phone,
                            address: orderData.customerData.address,
                            notes: orderData.customerData.notes,
                            marketing: orderData.customerData.marketing
                        }
                    })
                });

                const orderResult = await response.json();

                if (orderResult.success) {
                    currentOrder = {
                        trackingId: orderResult.trackingId,
                        orderNumber: orderResult.orderNumber,
                        title: orderData.title,
                        price: orderData.price,
                        total: orderResult.total
                    };
                    
                    addMessage(`
                        âœ… <strong>×”×–×× ×” × ×•×¦×¨×” ×‘×”×¦×œ×—×”!</strong><br>
                        ğŸ“§ <strong>××™×©×•×¨ ×”×–×× ×” × ×©×œ×— ×œ××™×™×œ:</strong> ${orderResult.customerEmail}<br>
                        ğŸ“¦ <strong>××¡×¤×¨ ×”×–×× ×”:</strong> #${orderResult.orderNumber}<br>
                        ğŸ’° <strong>×¡×›×•× ×œ×ª×©×œ×•×:</strong> â‚ª${orderResult.total}<br><br>
                        <button onclick="openPayPalDemo()" style="background: #0070ba; color: white; border: none; padding: 15px 25px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600;">
                            ğŸ’³ ×©×œ× ×¢×›×©×™×• (Demo)
                        </button>
                    `, 'assistant');
                    
                } else {
                    addMessage(`âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ×”×”×–×× ×”: ${orderResult.error}`, 'assistant');
                }
                
            } catch (error) {
                addMessage(`âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ×”×”×–×× ×”: ${error.message}`, 'assistant');
            }
        }

        // Open PayPal demo for payment
        function openPayPalDemo() {
            if (!currentOrder) return;

            const paymentContent = `<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <title>×ª×©×œ×•× ×××•×‘×˜×—</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f7f9fa; padding: 20px; direction: rtl; }
        .container { max-width: 400px; margin: 0 auto; background: white; border-radius: 12px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .logo { text-align: center; font-size: 32px; font-weight: bold; color: #0070ba; margin-bottom: 20px; }
        .demo-badge { background: #ff6b35; color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; text-align: center; margin-bottom: 20px; }
        .summary { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 25px; }
        .total { font-size: 24px; font-weight: bold; color: #0070ba; text-align: center; margin: 20px 0; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin: 10px 0; font-weight: 600; }
        .btn-pay { background: #0070ba; color: white; }
        .btn-cancel { background: #6c757d; color: white; }
        .loading { display: none; text-align: center; padding: 20px; }
        .success { display: none; text-align: center; color: #28a745; padding: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">ğŸ’³ ×ª×©×œ×•× ×××•×‘×˜×—</div>
        <div class="demo-badge">ğŸ§ª Demo Mode - ×ª×©×œ×•× ××“×•××”</div>
        
        <div id="payment-form">
            <div class="summary">
                <h3>×¡×™×›×•× ×”×”×–×× ×”</h3>
                <p><strong>××¡×¤×¨ ×”×–×× ×”:</strong> #${currentOrder.orderNumber}</p>
                <p><strong>××•×¦×¨:</strong> ${currentOrder.title}</p>
            </div>
            <div class="total">â‚ª${currentOrder.total}</div>
            <button class="btn btn-pay" onclick="processPayment()">ğŸ’³ ×©×œ× ×¢×›×©×™×•</button>
            <button class="btn btn-cancel" onclick="window.close()">âŒ ×‘×™×˜×•×œ</button>
        </div>
        
        <div id="loading" class="loading">
            <h3>××¢×‘×“ ×ª×©×œ×•×...</h3>
            <p>×× × ×”××ª×Ÿ...</p>
        </div>
        
        <div id="success" class="success">
            <h3>âœ… ×”×ª×©×œ×•× ×”×•×©×œ× ×‘×”×¦×œ×—×”!</h3>
            <p>×”×—×œ×•×Ÿ ×™×¡×’×¨ ×ª×•×š 3 ×©× ×™×•×ª...</p>
        </div>
    </div>

    <script>
        function processPayment() {
            document.getElementById("payment-form").style.display = "none";
            document.getElementById("loading").style.display = "block";
            
            setTimeout(() => {
                fetch("/api/orders/${currentOrder.trackingId}/pay", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ paymentMethod: "demo_payment" })
                }).then(response => response.json()).then(result => {
                    document.getElementById("loading").style.display = "none";
                    document.getElementById("success").style.display = "block";
                    window.opener.postMessage({ type: "payment_completed", order: result.order }, "*");
                    setTimeout(() => { window.close(); }, 3000);
                });
            }, 2000);
        }
    </script>
</body>
</html>`;

            const popup = window.open('', 'payment_demo', 'width=500,height=600,scrollbars=no,resizable=no');
            popup.document.open();
            popup.document.write(paymentContent);
            popup.document.close();
        }

        // Handle payment completion
        function handlePaymentComplete(order) {
            addMessage(`
                ğŸ‰ <strong>×”×ª×©×œ×•× ×”×•×©×œ× ×‘×”×¦×œ×—×”!</strong><br>
                ğŸ“¦ <strong>××¡×¤×¨ ×”×–×× ×”:</strong> #${order.orderNumber}<br>
                ğŸ’³ <strong>×¡×›×•× ×©×©×•×œ×:</strong> â‚ª${order.total}<br>
                ğŸ“… <strong>×ª××¨×™×š ×ª×©×œ×•×:</strong> ${new Date(order.paidAt).toLocaleString('he-IL')}<br><br>
                ×ª×•×“×” ×¢×œ ×”×¨×›×™×©×”! ×¤×¨×˜×™ ×”×”×–×× ×” × ×©×œ×—×• ×œ××™×™×œ ×©×œ×š.
            `, 'assistant');
        }

        // Utility function
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    </script>
</body>
</html>